<div class="profile-page-layout">
  <app-sidebar-nav class="column left-column"></app-sidebar-nav>

  <main class="column right-column">
    <div *ngIf="isLoading && !(profileData$ | async)" class="loading-state">
      <p>A carregar o perfil...</p>
    </div>

    <ng-container *ngIf="profileData$ | async as data">
      <header class="profile-header">
        <div class="avatar-container">
          <img 
            class="profile-avatar"
            [src]="data.profile.urlFotoPerfil || 'https://placehold.co/150x150/d1568e/FFFFFF?text=' + data.profile.username.charAt(0).toUpperCase()" 
            [alt]="'Foto de perfil de ' + data.profile.username">
        </div>
        
        <div class="profile-info">
          <div class="info-top">
            <h2 class="username">{{ data.profile.username }}</h2>
            <div class="action-buttons">
              <button *ngIf="data.isMyProfile" class="btn btn-secondary" (click)="openEditModal()">
                Editar Perfil
              </button>
              <ng-container *ngIf="!data.isMyProfile">
                <button 
                  *ngIf="!data.profile.seguidoPeloUsuarioAtual" 
                  class="btn btn-primary"
                  (click)="toggleFollow(data)">
                  Seguir
                </button>
                <button 
                  *ngIf="data.profile.seguidoPeloUsuarioAtual" 
                  class="btn btn-secondary"
                  (click)="toggleFollow(data)">
                  Seguindo
                </button>
              </ng-container>
            </div>
          </div>
          
          <div class="stats">
            <span><strong>{{ data.artworks.length }}</strong> publicações</span>
            <span><strong>{{ data.profile.contagemSeguidores }}</strong> seguidores</span>
            <span><strong>{{ data.profile.contagemSeguindo }}</strong> seguindo</span>
          </div>

          <div class="profile-details">
            <p class="full-name">{{ data.profile.nomeCompleto }}</p>
            <p class="bio">{{ data.profile.bio }}</p>

            <div class="social-links">
              
              <a *ngIf="data.profile.urlPortifolio" 
                 [href]="data.profile.urlPortifolio" 
                 target="_blank" rel="noopener noreferrer" class="social-link">
                Portfólio
              </a>
              
              <a *ngIf="data.profile.urlInstagram" 
                 [href]="data.profile.urlInstagram" 
                 target="_blank" rel="noopener noreferrer" class="social-link">
                Instagram
              </a>

              <a *ngIf="data.profile.urlLinkedin" 
                 [href]="data.profile.urlLinkedin" 
                 target="_blank" rel="noopener noreferrer" class="social-link">
                LinkedIn
              </a>
            </div>
            </div>
        </div>
      </header>

      <hr class="separator">

      <section class="timeline-feed">
        <div *ngIf="data.artworks.length === 0 && !isLoading" class="no-artworks-message">
          <p>Ainda não há publicações.</p>
        </div>
        
        <article *ngFor="let artwork of data.artworks" class="artwork-card">
          <header class="card-header">
             <a [routerLink]="['/profile/' + artwork.autorUsername]" class="author-link">
              <img
                [src]="artwork.urlFotoPerfilAutor
                ? artwork.urlFotoPerfilAutor
                : 'https://placehold.co/50x50/76A5AF/FFFFFF?text=' + artwork.autorUsername.charAt(0).toUpperCase()"
                [alt]="'Avatar de ' + artwork.autorUsername"
                class="author-avatar">
              <span class="author-name">{{ artwork.autorUsername }}</span>
            </a>
          </header>
          <div *ngIf="artwork.url" class="card-media-container" [ngSwitch]="artwork.calculatedMediaType">
            <img *ngSwitchCase="'imagem'"
                 [src]="artwork.url"
                 [alt]="artwork.titulo"
                 class="artwork-image">
            <plyr *ngSwitchDefault
                  class="plyr-container"
                  [class.audio-player-wrapper]="artwork.calculatedMediaType === 'audio'"
                  plyrTitle="{{ artwork.titulo }}"
                  [plyrSources]="artwork.plyrSourcesArray"
                  [plyrType]="artwork.plyrMediaTypeValue">   </plyr>
          </div>
          <footer class="card-footer">
             <div class="actions">
              <button class="action-btn" (click)="toggleLike(artwork)" [class.liked]="artwork.curtidaPeloUsuario">
                <span class="icon-heart"></span> <span class="btn-text">Gostei</span>
              </button>
              <button class="action-btn" (click)="toggleCommentBox(artwork)">Comentar</button>
            </div>
            <div class="likes">{{ artwork.totalCurtidas }} curtidas</div>
            <p class="description">
              <strong>{{ artwork.autorUsername }}</strong> {{ artwork.descricao }}
            </p>
            <div class="comments" (click)="openCommentsModal(artwork.id)">Ver todos os comentários</div>
            <div *ngIf="artwork.showCommentBox" class="comment-box">
              <form [formGroup]="commentForms.get(artwork.id)!" (ngSubmit)="submitComment(artwork)">
                <input type="text" formControlName="texto" placeholder="Adicione um comentário..." autofocus>
                <button type="submit" [disabled]="commentForms.get(artwork.id)?.invalid">Publicar</button>
              </form>
            </div>
          </footer>
        </article>

        <div *ngIf="isLoading" class="loading-state">
          <p>A carregar as obras de arte...</p>
        </div>
      </section>

      <app-edit-profile-modal
        *ngIf="isEditModalOpen"
        [userProfile]="data.profile"
        (close)="closeEditModal()"
        (profileUpdated)="onProfileUpdated($event)">
      </app-edit-profile-modal>

      <app-comments-modal
        *ngIf="isCommentsModalOpen && selectedArtworkIdForModal"
        [obraDeArteId]="selectedArtworkIdForModal"
        (close)="closeCommentsModal()">
      </app-comments-modal>

    </ng-container>
  </main>
</div>